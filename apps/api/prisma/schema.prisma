generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id         String    @id @default(uuid())
  name       String
  email      String    @unique
  role       String    // ADMIN or BUYER
  passwordHash String
  lastMfaAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  sessions   Session[]
  casesAssigned Case[] @relation("AssignedBuyer")
  caseExceptions Case[] @relation("ExceptionApprover")
  notifications Notification[]
  caseEvents CaseEvent[] @relation("EventActor")
  mfaChallenges MfaChallenge[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  expiresAt DateTime
  ip        String?
  userAgent String?
}

model MfaChallenge {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  codeHash   String
  createdAt  DateTime @default(now())
  expiresAt  DateTime
  attempts   Int      @default(0)
  consumedAt DateTime?
}

model Supplier {
  id         String   @id @default(uuid())
  name       String
  email      String
  categories String   // JSON array stored as string
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  quotes     Quote[]
}

model Case {
  id                   String     @id @default(uuid())
  prNumber             String
  subject              String
  requesterName        String
  requesterEmail       String
  department           String
  priority             String     // LOW, MEDIUM, HIGH, URGENT
  neededBy             DateTime
  costCenter           String
  deliveryLocation     String
  budgetEstimate       Float
  status               String     @default("NEW") // NEW, MISSING_INFO, ASSIGNED, WAITING_QUOTES, READY_FOR_REVIEW, READY_TO_SEND, SENT, CLOSED
  assignedBuyerId      String?
  assignedBuyer        User?      @relation("AssignedBuyer", fields: [assignedBuyerId], references: [id])
  exceptionApprovedById String?
  exceptionApprovedBy  User?      @relation("ExceptionApprover", fields: [exceptionApprovedById], references: [id])
  exceptionApprovedAt  DateTime?
  exceptionReason      String?
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  items                CaseItem[]
  checklist            ChecklistItem[]
  quotes               Quote[]
  files                File[]
  outboundEmails       OutboundEmailLog[]
  notifications        Notification[]
  events               CaseEvent[]
}

model CaseItem {
  id          String  @id @default(uuid())
  caseId      String
  case        Case    @relation(fields: [caseId], references: [id])
  description String
  qty         Float
  uom         String
  specs       String
}

model ChecklistItem {
  id        String   @id @default(uuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id])
  title     String
  status    String   // OPEN, DONE, BLOCKED
  ownerRole String   // SYSTEM, BUYER, REQUESTER
}

model Quote {
  id         String   @id @default(uuid())
  caseId     String
  case       Case     @relation(fields: [caseId], references: [id])
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  amount     Float
  currency   String
  receivedAt DateTime @default(now())
  fileId     String?
  file       File?    @relation(fields: [fileId], references: [id])
  notes      String?
}

model File {
  id         String   @id @default(uuid())
  caseId     String
  case       Case     @relation(fields: [caseId], references: [id])
  type       String   // PR_ATTACHMENT, QUOTE, OUTPUT
  filename   String
  mimeType   String
  size       Int
  storageKey String
  uploadedBy String
  createdAt  DateTime @default(now())
  quotes     Quote[]
}

model OutboundEmailLog {
  id                String   @id @default(uuid())
  caseId            String?
  case              Case?    @relation(fields: [caseId], references: [id])
  type              String   // RFQ, REQUEST_INFO, FINAL_RESPONSE, MFA_CODE
  to                String   // JSON array stored as string
  cc                String   // JSON array stored as string
  subject           String
  body              String
  attachmentFileIds String   // JSON array stored as string
  createdAt         DateTime @default(now())
  createdBy         String?
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  title     String
  body      String
  caseId    String?
  case      Case?    @relation(fields: [caseId], references: [id])
  severity  String   // INFO, WARN, CRITICAL
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model CaseEvent {
  id          String   @id @default(uuid())
  caseId      String
  case        Case     @relation(fields: [caseId], references: [id])
  actorUserId String?
  actor       User?    @relation("EventActor", fields: [actorUserId], references: [id])
  type        String
  detailJson  String
  createdAt   DateTime @default(now())
}
